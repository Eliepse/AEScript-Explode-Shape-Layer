var configs={title:"Explode layer tool",debug:!1,log:!1,itemAmountWarning:50,dryRun:!1};function cLog(e){configs.log&&$.writeln(e)}function cDebug(e){configs.debug&&$.writeln(e)}function listMatchNames(e){for(var t=1;t<=e.numProperties;t++){var r=e.property(t);consLog(r.matchName+"("+r.name+")")}}function ExecutionTime(){var e,t,r;this.constructor=function(){},this.start=function(){e=(new Date).getTime()},this.stop=function(){t=(new Date).getTime(),r=t-e},this.time=function(){return"Execution time : "+Math.floor(r/1e3)+"s "+r%1e3+"ms"}}function ProgressBar(e,t,r){var n,o,i,a,c,s;return this.testInfos="Processing element :current on :max",this.constructor=function(e,t,r){return _this=this,s=!1,a={min:e,max:t,current:r},(c={min:0,max:100,current:0}).max=a.max-a.min+1,(n=new Window("palette",configs.title,void 0,{resizeable:!1,borderless:"not quite true"})).preferredSize=[420,40],(o=n.add("progressbar",void 0,c.min,c.max)).preferredSize.width=400,o.show(),(i=n.add("statictext",void 0,"Loading, please wait",{justify:"center"})).preferredSize=[400,17],this.update(r),this},this.start=function(){s=!0,this.update(a.current),n.show()},this.end=function(){n.hide()},this.update=function(e){a.current=e,c.current=a.current+1-a.min;e=this.testInfos.replace(":current",c.current).replace(":max",c.max);o.value=c.current,cDebug(i.text=e),s&&n.update()},this.constructor(e,t,r)}function explodeLayer(e){cLog("Exploding layer : "+e.name);var t=e.property("Contents"),r=[];if(t.numProperties>configs.itemAmountWarning&&!confirm("You have more than "+configs.itemAmountWarning+" elements. Execution time might be long, are you sure you want to continue ?"))return;var n=new ProgressBar(1,t.numProperties,1);n.start();try{for(var o=t.numProperties;0<o;o--){var i,a=t.property(o);n.update(t.numProperties-o),a.enabled&&((i=emptyDuplicateLayer(e)).name=e.name+" - "+a.name,i.enabled=!1,i.shy=!0,r.push(i),i.property("Contents").canAddProperty(a.matchName)&&copyProperties(a,i.property("Contents").addProperty(a.matchName),0))}}catch(e){cLog("An error occured: "+e.message),n.end()}n.end();for(o=0;o<r.length;o++)r[o].enabled=!0,r[o].shy=!1,configs.dryRun&&r[o].remove();return r}function explode(){if(1<app.project.activeItem.selectedLayers.length)alert("Select a single shape layer");else{var e=app.project.activeItem.selectedLayers[0];if(null==e||"ADBE Vector Layer"!==e.matchName)alert("Select a shape layer");else{for(config in cLog("=================="),cLog("Configs :"),configs)configs.hasOwnProperty(config)&&cLog("    "+config+" : "+configs[config]);cLog("");var t=new ExecutionTime,r=(t.start(),e.containingComp.hideShyLayers);e.containingComp.hideShyLayers=!0,explodeLayer(e);e.moveToBeginning(),e.containingComp.hideShyLayers=r,t.stop(),cLog(t.time())}}}function emptyDuplicateLayer(e){var t=e.containingComp.layers.addShape();return t.anchorPoint.setValue(e.anchorPoint.value),t.position.setValue(e.position.value),t.scale.setValue(e.scale.value),t.rotation.setValue(e.rotation.value),t.opacity.setValue(e.opacity.value),t}var treeChildPrefix="⌞ ",propertiesBlacklist=["ADBE Vector Taper StartWidthPx","ADBE Vector Taper EndWidthPx","ADBE Vector Taper Wave Cycles","ADBE Vector Stroke Dashes","ADBE Vector Materials Group"];function copyProperties(e,t,r){var n=repeatStr("  ",r);cDebug(n+e.name);for(var o=1;o<=e.numProperties;o++){var i,a=e.property(o),c=a.matchName;a.enabled?(i=(i=t.property(c))||t.addProperty(c))?arrayIncludes(propertiesBlacklist,c)?cDebug(n+"⚬ "+c+" (skipped: not editable when hidden)"):"function"==typeof a.setValue?(cDebug(n+treeChildPrefix+c),i.setValue(a.value)):0<a.numProperties?(cDebug(n+treeChildPrefix+c),copyProperties(a,i,r+1)):cDebug(n+"⦵ "+c+" (skipped: no reason)"):cDebug(n+treeChildPrefix+c+" (skipped: cannot be added)"):cDebug(n+treeChildPrefix+c+" (skipped: disabled)")}}function arrayIncludes(e,t){for(var r=e.length-1;0<=r;r--)if(e[r]===t)return!0;return!1}function repeatStr(e,t){for(var r="",n=0;n<t;n++)r+=e;return r}function createUI(e){e instanceof Panel?t=e:(t=new Window("palette",configs.title,void 0,{resizeable:!0})).show();var t,e=t.add("button",[10,10,100,30],"Explode layer");return t.bounds.width=120,t.bounds.height=40,e.onClick=function(){explode()},t}var _panel=createUI(this);